name: Build

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  release:
    name: ${{ matrix.config.os }}${{ matrix.target.name }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
          - {
              name: windows,
              os: windows-2025,
              artifact: "infomap-win",
              binary: Infomap.exe,
              cxxflags: -static,
              ldflags: -static,
              compiler: g++,
            }
          - {
              name: ubuntu,
              os: ubuntu-24.04,
              artifact: "infomap-ubuntu",
              binary: Infomap,
              cxxflags: "",
              ldflags: "",
              compiler: g++,
            }
          - {
              name: macos,
              os: macos-15,
              artifact: "infomap-mac",
              binary: Infomap,
              cxxflags: "",
              ldflags: "",
              compiler: clang++,
            }
        target:
          - { name: "", target: "" }
          - { name: "-noomp", target: "noomp" }

    steps:
      - uses: actions/checkout@v4

      - if: startsWith(matrix.config.os, 'macos')
        run: |
          brew install llvm libomp
          BREW_PREFIX="$(brew --prefix)"
          echo "PATH=$BREW_PREFIX/opt/llvm/bin:${PATH}" >> $GITHUB_ENV
          echo "CPPFLAGS=-I$BREW_PREFIX/opt/llvm/include -I$BREW_PREFIX/opt/libomp/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L$BREW_PREFIX/opt/llvm/lib/c++ -L$BREW_PREFIX/opt/llvm/lib/unwind -lunwind -L$BREW_PREFIX/opt/libomp/lib" >> $GITHUB_ENV
          echo "MACOSX_DEPLOYMENT_TARGET=15.0" >> $GITHUB_ENV
          echo "CXX=$BREW_PREFIX/opt/llvm/bin/clang++" >> $GITHUB_ENV

      - run: make -j ${{ matrix.target.target }}
        shell: bash
        env:
          CXX: ${{ matrix.config.compiler }}
          CXXFLAGS: ${{ matrix.config.cxxflags }} ${{ env.CPPFLAGS }}
          LDFLAGS: ${{ matrix.config.ldflags }} ${{ env.LDFLAGS }}

      - run: ./Infomap --version
        shell: bash
